<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Offer Seat Booking</title>
  <link rel="stylesheet" href="./style/offfersit.css" />
</head>

<body>
  <div class="card">
    <h1>Offer Seat Booking</h1>

    <section id="step-user" class="step active">
      <form id="user-details-form">
        <h2>Step 1: Your Details</h2>
        <label for="name">Name</label>
        <input type="text" id="name" required placeholder="Your Name">
        <label for="phone">Phone</label>
        <input type="tel" id="phone" required placeholder="Your Phone Number" pattern="[0-9]{10}">
        <label for="email">Email</label>
        <input type="email" id="email" required placeholder="Your Email">
        <div class="btn-row">
          <button class="btn" type="submit">Next: Date →</button>
        </div>
      </form>
    </section>

    <section id="step-date" class="step">
      <h2>Step 2: Select Date</h2>
      <label for="date">Choose a date</label>
      <input id="date" type="date" required />
      <div class="btn-row">
        <button id="back-to-user" class="ghost">← Back</button>
        <button id="to-time" class="btn" disabled>Next: Time →</button>
      </div>
    </section>
    
    <section id="step-time" class="step">
      <h2>Step 3: Select Time</h2>
      <div id="time-buttons" class="time-buttons"></div>
      <div class="btn-row">
        <button id="back-to-date" class="ghost">← Back</button>
        <button id="to-seats" class="btn" disabled>Next: Seats →</button>
      </div>
    </section>

    <section id="step-seats" class="step">
      <h2>Step 4: Select Your Seats</h2>
      <div class="screen">Screen</div>
      <div id="seats-grid" class="seats-grid"></div>
      <div class="meta">
        <div><strong>Movie:</strong> <span id="meta-movie-name">—</span></div>
        <div><strong>Show:</strong> <span id="meta-show">—</span></div>
        <div><strong>Selected:</strong> <span id="selected-count">0</span> seats</div>
        <div><strong>Total:</strong> ₹<span id="total-price">0</span></div>
        <div style="grid-column: 1 / -1;"><strong>Seats:</strong> <span id="selected-list">—</span></div>
      </div>
      <div class="btn-row">
        <button id="back-to-time" class="ghost">← Back</button>
        <button id="confirm-book" class="btn" disabled>Confirm Booking</button>
      </div>
    </section>
  </div>

<script>
// --- CONFIGURATION ---
const SEATS_COUNT = 72;
const SHOW_TIMES = ["10:00 AM", "01:00 PM", "04:00 PM", "07:00 PM", "10:00 PM"];

// --- INITIAL CHECK ---
const movieName = localStorage.getItem("selectedMovieName");
const moviePrice = Number(localStorage.getItem("selectedMoviePrice"));

if (!movieName || !moviePrice) {
  alert("No offer selected. Redirecting you to the offers page.");
  window.location.href = "offer.php";
}

// --- STATE MANAGEMENT ---
const state = {
  user: { name: null, phone: null, email: null },
  date: null,
  time: null,
  selectedSeats: [],
  movie: { name: movieName, price: moviePrice }
};

// --- HELPER FUNCTIONS ---
function goTo(stepId) {
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  document.getElementById(stepId).classList.add('active');
}

function generateStorageKey(movie, date, time) {
  const formattedMovie = movie.replace(/\s+/g, '_');
  const formattedTime = time.replace(/[:\s]/g, '');
  return `booking__${formattedMovie}__${date}__${formattedTime}`;
}

function getBookedSeats(movie, date, time) {
  const key = generateStorageKey(movie, date, time);
  const rawData = localStorage.getItem(key);
  return rawData ? JSON.parse(rawData) : [];
}

function saveBookedSeats(movie, date, time, seats) {
  const key = generateStorageKey(movie, date, time);
  localStorage.setItem(key, JSON.stringify(seats));
}

// --- RENDER & UPDATE FUNCTIONS ---
function renderSeats() {
  const grid = document.getElementById('seats-grid');
  grid.innerHTML = '';
  const bookedSeats = getBookedSeats(state.movie.name, state.date, state.time);
  state.selectedSeats = []; // Clear previous selection when rendering

  for (let i = 1; i <= SEATS_COUNT; i++) {
    const seatNumber = String(i);
    const seat = document.createElement('div');
    seat.className = 'seat';
    seat.textContent = seatNumber;

    if (bookedSeats.includes(seatNumber)) {
      seat.classList.add('booked');
    }

    seat.addEventListener('click', () => {
      if (seat.classList.contains('booked')) return;
      
      const seatIndex = state.selectedSeats.indexOf(seatNumber);
      if (seatIndex > -1) {
        state.selectedSeats.splice(seatIndex, 1);
        seat.classList.remove('selected');
      } else {
        state.selectedSeats.push(seatNumber);
        seat.classList.add('selected');
      }
      updateMeta();
    });
    grid.appendChild(seat);
  }
}

function updateMeta() {
  document.getElementById('meta-movie-name').textContent = state.movie.name;
  const showInfo = (state.date || '—') + ', ' + (state.time || '—');
  document.getElementById('meta-show').textContent = showInfo;
  document.getElementById('selected-count').textContent = state.selectedSeats.length;
  document.getElementById('selected-list').textContent = state.selectedSeats.sort((a, b) => Number(a) - Number(b)).join(', ') || '—';
  document.getElementById('total-price').textContent = (state.selectedSeats.length * state.movie.price).toFixed(2);
  document.getElementById('confirm-book').disabled = state.selectedSeats.length === 0;
}

// --- BOOKING CONFIRMATION ---
function onConfirmBooking() {
  if (state.selectedSeats.length === 0) return;

  const currentBookedSeats = getBookedSeats(state.movie.name, state.date, state.time);
  const newBookingData = [...new Set([...currentBookedSeats, ...state.selectedSeats])].sort((a, b) => Number(a) - Number(b));
  saveBookedSeats(state.movie.name, state.date, state.time, newBookingData);

  localStorage.setItem('bookingUser', JSON.stringify(state.user));
  localStorage.setItem('selectedDate', state.date);
  localStorage.setItem('selectedTime', state.time);
  localStorage.setItem('selectedSeats', JSON.stringify(state.selectedSeats));
  
  window.location.href = "offerbill.php";
}

// --- EVENT LISTENERS ---
document.addEventListener('DOMContentLoaded', () => {
  // Step 1: User Form
  document.getElementById('user-details-form').addEventListener('submit', (e) => {
    e.preventDefault();
    state.user.name = document.getElementById('name').value.trim();
    state.user.phone = document.getElementById('phone').value.trim();
    state.user.email = document.getElementById('email').value.trim();
    if (state.user.name && state.user.phone && state.user.email) {
      goTo('step-date');
    }
  });

  // Step 2: Date Selection
  const dateInput = document.getElementById('date');
  dateInput.min = new Date().toISOString().slice(0, 10);
  dateInput.addEventListener('change', () => {
    state.date = dateInput.value;
    state.time = null; // Reset time when date changes
    state.selectedSeats = []; // Reset seats
    document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('to-time').disabled = !state.date;
    document.getElementById('to-seats').disabled = true;
  });

  // Step 3: Time Selection
  const timeButtonsContainer = document.getElementById('time-buttons');
  SHOW_TIMES.forEach(time => {
    const btn = document.createElement('button');
    btn.className = 'time-btn';
    btn.textContent = time;
    btn.onclick = () => {
      state.time = time;
      document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('to-seats').disabled = false;
    };
    timeButtonsContainer.appendChild(btn);
  });
  
  // Navigation Buttons
  document.getElementById('back-to-user').addEventListener('click', () => goTo('step-user'));
  document.getElementById('to-time').addEventListener('click', () => goTo('step-time'));
  document.getElementById('back-to-date').addEventListener('click', () => goTo('step-date'));
  document.getElementById('to-seats').addEventListener('click', () => {
    renderSeats();
    updateMeta();
    goTo('step-seats');
  });
  document.getElementById('back-to-time').addEventListener('click', () => goTo('step-time'));
  document.getElementById('confirm-book').addEventListener('click', onConfirmBooking);
});
</script>

</body>
</html>